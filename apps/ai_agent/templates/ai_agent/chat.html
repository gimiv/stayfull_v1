<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nora - AI Assistant</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>

    <!-- Custom styles -->
    <style>
        /* Stripe-inspired design system */
        :root {
            --primary: #0066FF;
            --primary-dark: #0A2540;
            --surface: #F6F9FC;
            --border: #E3E8EE;
            --text: #0A2540;
            --text-secondary: #425466;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--surface);
        }

        /* Hide scrollbar but keep functionality */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Message animations */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-enter {
            animation: slideIn 0.3s ease-out;
        }

        /* Microphone button pulse animation */
        @keyframes pulse-ring {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            100% {
                transform: scale(1.3);
                opacity: 0;
            }
        }

        .recording .pulse-ring {
            animation: pulse-ring 1.5s cubic-bezier(0.455, 0.03, 0.515, 0.955) infinite;
        }

        /* Loading dots */
        .loading-dots span {
            animation: blink 1.4s infinite both;
        }
        .loading-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }
        .loading-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }
        @keyframes blink {
            0%, 80%, 100% { opacity: 0; }
            40% { opacity: 1; }
        }
    </style>
</head>
<body class="h-screen overflow-hidden">

    <!-- Main container: Split-screen on desktop, tabs on mobile -->
    <div class="flex flex-col md:flex-row h-screen">

        <!-- Left Panel: Chat Interface (50% on desktop, full on mobile) -->
        <div class="flex flex-col w-full md:w-1/2 bg-white border-r border-gray-200">

            <!-- Header -->
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-blue-500 flex items-center justify-center text-white font-bold">
                        N
                    </div>
                    <div>
                        <h1 class="text-lg font-semibold text-gray-900">Nora</h1>
                        <p class="text-sm text-gray-500">Your AI co-worker</p>
                    </div>
                </div>

                <!-- Mobile tab toggle -->
                <button
                    onclick="togglePreview()"
                    class="md:hidden px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200"
                >
                    Preview
                </button>
            </div>

            <!-- Progress Bar (shown during onboarding) -->
            <div id="progress-container" class="px-6 py-3 bg-blue-50 border-b border-blue-100" style="display: none;">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-medium text-blue-900" id="progress-text">Setting up your hotel</span>
                    <span class="text-sm font-semibold text-blue-600" id="progress-percent">0%</span>
                </div>
                <div class="w-full bg-blue-200 rounded-full h-2">
                    <div id="progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>

            <!-- Messages Container -->
            <div id="messages" class="flex-1 overflow-y-auto px-6 py-4 space-y-4 scrollbar-hide">
                <!-- Messages will be dynamically added here -->
                <div class="text-center text-gray-400 text-sm py-8">
                    Start a conversation with Nora
                </div>
            </div>

            <!-- Input Area -->
            <div class="px-6 py-4 border-t border-gray-200 bg-white">
                <form id="message-form" class="flex items-end space-x-3" onsubmit="sendMessage(event)">
                    <!-- Text Input -->
                    <div class="flex-1">
                        <textarea
                            id="message-input"
                            rows="1"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="Type a message or use voice..."
                            onkeydown="handleKeyPress(event)"
                        ></textarea>
                    </div>

                    <!-- Voice Button -->
                    <button
                        type="button"
                        id="voice-btn"
                        onclick="toggleVoiceRecording()"
                        class="relative flex items-center justify-center px-4 h-12 bg-blue-100 hover:bg-blue-200 text-blue-700 font-medium rounded-lg transition-all duration-200"
                        title="Voice input"
                    >
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/>
                        </svg>
                        <span id="voice-btn-text">Speak to Nora</span>
                        <div class="pulse-ring absolute inset-0 rounded-lg bg-red-400 opacity-0"></div>
                    </button>

                    <!-- Send Button -->
                    <button
                        type="submit"
                        class="flex items-center justify-center w-12 h-12 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors"
                        title="Send message"
                    >
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                        </svg>
                    </button>
                </form>

                <!-- Voice Recording Indicator -->
                <div id="recording-indicator" class="mt-3 hidden">
                    <div class="flex items-center space-x-2 text-red-600">
                        <div class="w-3 h-3 bg-red-600 rounded-full animate-pulse"></div>
                        <span class="text-sm font-medium">Recording...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel: Live Preview (50% on desktop, hidden on mobile by default) -->
        <div id="preview-panel" class="hidden md:flex flex-col w-full md:w-1/2 bg-gray-50">
            <!-- Preview Header -->
            <div class="px-6 py-4 border-b border-gray-200 bg-white">
                <div class="flex items-center justify-between">
                    <h2 class="text-lg font-semibold text-gray-900">Live Preview</h2>
                    <button
                        onclick="togglePreview()"
                        class="md:hidden text-gray-500 hover:text-gray-700"
                    >
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Preview Content -->
            <div id="preview-content" class="flex-1 overflow-y-auto">
                <!-- Phase 4.5: Progress Tracker (HTMX polling every 3s) -->
                <div
                    id="progress-tracker"
                    hx-get="/nora/api/progress/"
                    hx-trigger="load, every 3s"
                    hx-swap="innerHTML"
                >
                    <!-- Initial loading state -->
                    <div class="p-6">
                        <div class="text-center text-gray-400 py-12">
                            <svg class="w-12 h-12 mx-auto mb-4 text-gray-300 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                            </svg>
                            <p class="text-sm">Loading progress...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;

        // Send text message
        async function sendMessage(event) {
            event.preventDefault();

            const input = document.getElementById('message-input');
            const message = input.value.trim();

            if (!message) return;

            // Clear input
            input.value = '';
            input.style.height = 'auto';

            // Add user message to chat
            addMessage('user', message);

            // Show loading indicator
            showLoading();

            try {
                const response = await fetch('/nora/api/message/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({ message: message })
                });

                const data = await response.json();

                // Remove loading indicator
                hideLoading();

                // Add Nora's response
                addMessage('assistant', data.message);

                // Update progress if present
                if (data.data && data.data.progress !== undefined) {
                    updateProgress(data.data.progress, data.data.state);
                }

                // Handle actions
                if (data.action) {
                    handleAction(data.action, data.data);
                }

            } catch (error) {
                hideLoading();
                addMessage('assistant', "I'm having trouble right now. Let's try again in a moment.");
                console.error('Error:', error);
            }
        }

        // Add message to chat
        function addMessage(role, content) {
            const messagesDiv = document.getElementById('messages');

            // Remove "start conversation" message if present
            const emptyState = messagesDiv.querySelector('.text-center.text-gray-400');
            if (emptyState) emptyState.remove();

            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'} message-enter`;

            const bubble = document.createElement('div');
            bubble.className = `max-w-[80%] px-4 py-3 rounded-lg ${
                role === 'user'
                    ? 'bg-blue-600 text-white'
                    : 'bg-gray-100 text-gray-900'
            }`;
            bubble.textContent = content;

            messageDiv.appendChild(bubble);
            messagesDiv.appendChild(messageDiv);

            // Scroll to bottom
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Show loading indicator
        function showLoading() {
            const messagesDiv = document.getElementById('messages');
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loading-indicator';
            loadingDiv.className = 'flex justify-start';
            loadingDiv.innerHTML = `
                <div class="bg-gray-100 px-4 py-3 rounded-lg">
                    <div class="loading-dots flex space-x-1">
                        <span class="w-2 h-2 bg-gray-500 rounded-full"></span>
                        <span class="w-2 h-2 bg-gray-500 rounded-full"></span>
                        <span class="w-2 h-2 bg-gray-500 rounded-full"></span>
                    </div>
                </div>
            `;
            messagesDiv.appendChild(loadingDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function hideLoading() {
            const loading = document.getElementById('loading-indicator');
            if (loading) loading.remove();
        }

        // Update progress bar
        function updateProgress(percent, state) {
            const container = document.getElementById('progress-container');
            const bar = document.getElementById('progress-bar');
            const percentText = document.getElementById('progress-percent');
            const stateText = document.getElementById('progress-text');

            container.style.display = 'block';
            bar.style.width = percent + '%';
            percentText.textContent = percent + '%';

            // Update state text
            const stateNames = {
                'hotel_basics': 'Hotel basics',
                'room_types': 'Room types',
                'policies': 'Policies',
                'review': 'Review',
                'complete': 'Complete!'
            };
            stateText.textContent = stateNames[state] || 'Setting up your hotel';
        }

        // Handle special actions
        function handleAction(action, data) {
            if (action === 'show_progress') {
                updateProgress(data.progress || 0, data.step);
            } else if (action === 'update_progress') {
                updateProgress(data.progress, data.state);
            } else if (action === 'complete_onboarding') {
                // Celebrate!
                setTimeout(() => {
                    alert('🎉 Your hotel is ready!');
                }, 500);
            }
        }

        // Voice recording
        async function toggleVoiceRecording() {
            if (!isRecording) {
                await startRecording();
            } else {
                await stopRecording();
            }
        }

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    await sendVoiceMessage(audioBlob);
                };

                mediaRecorder.start();
                isRecording = true;

                // Update UI
                const voiceBtn = document.getElementById('voice-btn');
                const voiceBtnText = document.getElementById('voice-btn-text');

                voiceBtn.classList.add('recording', 'bg-red-500', 'hover:bg-red-600', 'text-white');
                voiceBtn.classList.remove('bg-blue-100', 'hover:bg-blue-200', 'text-blue-700');
                voiceBtnText.textContent = 'Stop Recording';
                document.getElementById('recording-indicator').classList.remove('hidden');

            } catch (error) {
                console.error('Error accessing microphone:', error);
                alert('Could not access microphone. Please check permissions.');
            }
        }

        async function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
                isRecording = false;

                // Update UI
                const voiceBtn = document.getElementById('voice-btn');
                const voiceBtnText = document.getElementById('voice-btn-text');

                voiceBtn.classList.remove('recording', 'bg-red-500', 'hover:bg-red-600', 'text-white');
                voiceBtn.classList.add('bg-blue-100', 'hover:bg-blue-200', 'text-blue-700');
                voiceBtnText.textContent = 'Speak to Nora';
                document.getElementById('recording-indicator').classList.add('hidden');
            }
        }

        async function sendVoiceMessage(audioBlob) {
            showLoading();

            try {
                const formData = new FormData();
                formData.append('audio', audioBlob, 'recording.webm');

                const response = await fetch('/nora/api/voice/message/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: formData
                });

                const data = await response.json();

                hideLoading();

                // Add transcribed text as user message
                addMessage('user', data.transcribed_text);

                // Add Nora's response
                addMessage('assistant', data.message);

                // Play audio response
                if (data.audio_base64) {
                    const audio = new Audio('data:audio/mp3;base64,' + data.audio_base64);
                    audio.play();
                }

                // Handle progress/actions
                if (data.data && data.data.progress !== undefined) {
                    updateProgress(data.data.progress, data.data.state);
                }

            } catch (error) {
                hideLoading();
                console.error('Voice error:', error);
                addMessage('assistant', "I had trouble with that audio. Want to type instead?");
            }
        }

        // Mobile preview toggle
        function togglePreview() {
            const preview = document.getElementById('preview-panel');
            preview.classList.toggle('hidden');
        }

        // Auto-resize textarea
        document.getElementById('message-input').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });

        // Handle Enter key (submit) vs Shift+Enter (new line)
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage(event);
            }
        }

        // Get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // PHASE 5: Edit Modal Functions
        function openEditModal(modalType) {
            let endpoint = '';

            switch(modalType) {
                case 'payment':
                    endpoint = '/nora/api/edit/payment-policy/';
                    break;
                case 'cancellation':
                    endpoint = '/nora/api/edit/cancellation-policy/';
                    break;
                case 'checkin':
                    endpoint = '/nora/api/edit/checkin-times/';
                    break;
                default:
                    console.error('Unknown modal type:', modalType);
                    return;
            }

            // Fetch and display modal
            fetch(endpoint, {
                method: 'GET',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.text())
            .then(html => {
                // Insert modal into page
                document.body.insertAdjacentHTML('beforeend', html);
            })
            .catch(error => {
                console.error('Error loading modal:', error);
                alert('Failed to load edit modal');
            });
        }

        // Update preview panel with editable sections
        function updatePreviewWithEditButtons(data) {
            const previewContent = document.getElementById('preview-content');

            if (!data || !data.policies) {
                return;
            }

            previewContent.innerHTML = `
                <div class="max-w-3xl mx-auto space-y-6">
                    <div class="bg-white rounded-lg shadow-sm p-6 border border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Hotel Policies</h3>

                        <!-- Payment Policy -->
                        <div class="mb-6 pb-6 border-b border-gray-200">
                            <div class="flex items-start justify-between mb-2">
                                <h4 class="text-sm font-medium text-gray-700">Payment Policy</h4>
                                <button
                                    onclick="openEditModal('payment')"
                                    class="text-xs text-blue-600 hover:text-blue-700 font-medium flex items-center"
                                >
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                    </svg>
                                    Edit
                                </button>
                            </div>
                            <p class="text-gray-800" data-policy="payment">
                                ${data.policies.payment || '💳 50% deposit at booking, rest on arrival'}
                            </p>
                        </div>

                        <!-- Cancellation Policy -->
                        <div class="mb-6 pb-6 border-b border-gray-200">
                            <div class="flex items-start justify-between mb-2">
                                <h4 class="text-sm font-medium text-gray-700">Cancellation Policy</h4>
                                <button
                                    onclick="openEditModal('cancellation')"
                                    class="text-xs text-blue-600 hover:text-blue-700 font-medium flex items-center"
                                >
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                    </svg>
                                    Edit
                                </button>
                            </div>
                            <p class="text-gray-800" data-policy="cancellation">
                                ${data.policies.cancellation || '❌ Free cancellation up to 72 hours before arrival'}
                            </p>
                        </div>

                        <!-- Check-in/Check-out Times -->
                        <div>
                            <div class="flex items-start justify-between mb-2">
                                <h4 class="text-sm font-medium text-gray-700">Check-in/Check-out</h4>
                                <button
                                    onclick="openEditModal('checkin')"
                                    class="text-xs text-blue-600 hover:text-blue-700 font-medium flex items-center"
                                >
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                    </svg>
                                    Edit
                                </button>
                            </div>
                            <div class="text-gray-800 space-y-1">
                                <p>📍 Check-in: <span data-time="checkin">${data.policies.checkin || '3:00 PM'}</span></p>
                                <p>📍 Check-out: <span data-time="checkout">${data.policies.checkout || '11:00 AM'}</span></p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <div class="flex items-start space-x-2">
                            <svg class="w-5 h-5 text-blue-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <div class="flex-1">
                                <p class="text-sm text-blue-900">
                                    <strong>You control the data,</strong> Nora controls the presentation.
                                    Edit the settings using the buttons above.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>
