<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Welcome to Nora</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    {% load static %}

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }

        .float-animation {
            animation: float 3s ease-in-out infinite;
        }

        @keyframes gradient-shift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .animated-gradient {
            background: linear-gradient(270deg, #1a1464, #004d66, #3d1d66);
            background-size: 400% 400%;
            animation: gradient-shift 8s ease infinite;
        }
    </style>
</head>
<body class="bg-gray-50">

    <!-- Main Container -->
    <div class="min-h-screen flex items-center justify-center px-4 py-12">
        <div class="max-w-4xl w-full">

            <!-- Welcome Card -->
            <div class="bg-white rounded-2xl shadow-xl overflow-hidden">

                <!-- Header with Gradient - Use flex to push content to bottom -->
                <div class="animated-gradient p-8 md:p-16 text-center flex flex-col" style="min-height: 900px;">
                    <!-- Nora Avatar with Voice-Reactive Ring (Always Visible) - MOVED TO TOP -->
                    <div class="flex flex-col items-center pt-8 pb-12">
                        <!-- Container for ring - larger to prevent cutoff, with overflow visible -->
                        <div class="relative group cursor-pointer mb-6" style="width: 600px; height: 600px;">
                            <!-- Voice-reactive ring visualizer (hidden until play) - larger canvas -->
                            <canvas id="voice-ring" width="600" height="600" class="absolute hidden" style="left: 50%; top: 50%; transform: translate(-50%, -50%);"></canvas>

                            <!-- Nora Avatar (Always Visible) - 2.5x larger - Centered in container -->
                            <div class="absolute rounded-full overflow-hidden shadow-2xl z-10 border-4 border-white/40" style="width: 400px; height: 400px; left: 50%; top: 50%; transform: translate(-50%, -50%);">
                                <img
                                    src="{% static 'ai_agent/images/nora-avatar.png' %}"
                                    alt="Nora AI Assistant"
                                    class="w-full h-full object-cover"
                                />
                            </div>

                            <!-- Netflix-style Play Button Overlay - larger -->
                            <button
                                id="play-overlay-btn"
                                onclick="startIntroExperience()"
                                class="absolute inset-0 flex items-center justify-center z-20 group-hover:opacity-100 opacity-90 transition-opacity duration-200"
                                style="left: 50%; top: 50%; transform: translate(-50%, -50%); width: 400px; height: 400px;"
                            >
                                <!-- Play icon circle - larger -->
                                <div class="w-24 h-24 rounded-full bg-white/90 hover:bg-white flex items-center justify-center shadow-2xl transform group-hover:scale-110 transition-transform duration-200">
                                    <svg class="w-12 h-12 text-gray-900 ml-1" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"/>
                                    </svg>
                                </div>
                            </button>
                        </div>

                        <!-- Player Controls - Always take up space to prevent layout shift -->
                        <div id="intro-controls" class="flex items-center justify-center space-x-4" style="min-height: 52px;">
                            <button
                                id="pause-btn"
                                onclick="pauseIntro()"
                                class="hidden p-3 bg-white/20 hover:bg-white/30 rounded-full transition-colors"
                                title="Pause"
                            >
                                <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"/>
                                </svg>
                            </button>
                            <button
                                id="restart-btn"
                                onclick="restartIntro()"
                                class="hidden p-3 bg-white/20 hover:bg-white/30 rounded-full transition-colors"
                                title="Restart"
                            >
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- Text Content -->
                    <h1 class="text-4xl md:text-5xl font-bold text-white mb-3">
                        Meet Nora
                    </h1>
                    <p class="text-xl text-white/90 mb-6">
                        Your AI co-worker who gets hotels online in 10 minutes
                    </p>

                    <!-- Spacer to push content to bottom -->
                    <div class="flex-grow"></div>

                    <!-- CTA Button (at bottom, above subtitles) -->
                    <div class="text-center mb-8 mt-8">
                        <form action="{% url 'ai_agent:start_onboarding' %}" method="post">
                            {% csrf_token %}
                            <button
                                type="submit"
                                class="inline-flex items-center px-12 py-5 text-2xl font-bold text-white bg-white/30 hover:bg-white/40 backdrop-blur-sm rounded-xl hover:scale-105 transition-all shadow-2xl border-2 border-white/50"
                                onclick="startOnboarding(event)"
                            >
                                <span>Let's Go, Nora!</span>
                                <svg class="ml-3 w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"/>
                                </svg>
                            </button>
                        </form>
                    </div>

                    <!-- Subtitles (at very bottom) -->
                    <div id="subtitle-container" class="hidden mb-8">
                        <div class="bg-white/10 backdrop-blur-sm rounded-lg px-6 py-4 mb-4 min-h-[100px] flex items-center justify-center max-w-2xl mx-auto">
                            <p id="subtitle-text" class="text-white text-xl text-center leading-relaxed">
                                <!-- Subtitle text will appear here -->
                            </p>
                        </div>

                        <!-- Status indicator -->
                        <div id="audio-status" class="text-white/80 text-sm font-medium">
                            <!-- Will show "Nora is speaking..." or "Listening..." -->
                        </div>
                    </div>
                </div>

            </div>

        </div>
    </div>

    <style>
        @keyframes wave {
            0%, 100% { transform: scaleY(1); }
            50% { transform: scaleY(1.5); }
        }

        .animate-wave {
            animation: wave 0.6s ease-in-out infinite;
        }

        @keyframes typing {
            from { width: 0; }
            to { width: 100%; }
        }

        .typing-text {
            overflow: hidden;
            white-space: nowrap;
            display: inline-block;
            animation: typing 3s steps(60, end);
        }
    </style>

    <script>
        // Intro experience with synced audio and subtitles
        const introMessage = `Hi there! I'm Nora, your AI co-worker at Stayfull. I'm here to help you get your hotel online in just 10 minutes. Here's what we'll do together: First, I'll gather your hotel's basic information. Then, we'll set up your rooms and pricing. Finally, I'll help you create professional policies and descriptions. The best part? You can talk to me anytime - whether it's for onboarding, daily operations, or just questions about how things work. Ready to get started? Let's build something amazing together!`;

        // Subtitle segments with approximate timing (characters per second ~= 15)
        const subtitleSegments = [
            { text: "Hi there! I'm Nora, your AI co-worker at Stayfull.", start: 0, duration: 3500 },
            { text: "I'm here to help you get your hotel online in just 10 minutes.", start: 3500, duration: 4000 },
            { text: "Here's what we'll do together:", start: 7500, duration: 2500 },
            { text: "First, I'll gather your hotel's basic information.", start: 10000, duration: 3500 },
            { text: "Then, we'll set up your rooms and pricing.", start: 13500, duration: 3000 },
            { text: "Finally, I'll help you create professional policies and descriptions.", start: 16500, duration: 4500 },
            { text: "The best part? You can talk to me anytime.", start: 21000, duration: 3500 },
            { text: "Whether it's for onboarding, daily operations, or just questions about how things work.", start: 24500, duration: 5000 },
            { text: "Ready to get started? Let's build something amazing together!", start: 29500, duration: 4500 }
        ];

        let currentAudio = null;
        let subtitleTimeouts = [];
        let isPaused = false;
        let currentSegmentIndex = 0;
        let audioStartTime = 0;
        let voiceVisualizer = null;

        // Voice-reactive ring visualizer
        class VoiceVisualizer {
            constructor(canvasId) {
                this.canvas = document.getElementById(canvasId);
                this.ctx = this.canvas.getContext('2d');
                this.audioContext = null;
                this.analyser = null;
                this.dataArray = null;
                this.animationId = null;
                this.isActive = false;
            }

            // Initialize with audio element (for Nora speaking)
            initWithAudio(audioElement) {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    this.analyser = this.audioContext.createAnalyser();
                    this.analyser.fftSize = 256;

                    const source = this.audioContext.createMediaElementSource(audioElement);
                    source.connect(this.analyser);
                    this.analyser.connect(this.audioContext.destination);

                    this.dataArray = new Uint8Array(this.analyser.frequencyBinCount);
                    this.isActive = true;
                    this.animate();

                    document.getElementById('audio-status').textContent = '🔊 Nora is speaking...';
                } catch (error) {
                    console.error('Error initializing audio visualizer:', error);
                }
            }

            // Initialize with microphone (for user speaking)
            async initWithMicrophone() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    this.analyser = this.audioContext.createAnalyser();
                    this.analyser.fftSize = 256;

                    const source = this.audioContext.createMediaStreamSource(stream);
                    source.connect(this.analyser);

                    this.dataArray = new Uint8Array(this.analyser.frequencyBinCount);
                    this.isActive = true;
                    this.animate();

                    document.getElementById('audio-status').textContent = '🎤 Listening...';
                } catch (error) {
                    console.error('Error accessing microphone:', error);
                    document.getElementById('audio-status').textContent = '⚠️ Microphone access denied';
                }
            }

            // Draw the voice-reactive ring
            draw(amplitude) {
                const centerX = this.canvas.width / 2;
                const centerY = this.canvas.height / 2;
                const baseRadius = 220; // Slightly inside the 400px avatar (200px from center)

                // Clear canvas
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

                // Calculate ring expansion based on audio amplitude
                const expansion = (amplitude / 255) * 50; // Max 50px expansion

                // Draw multiple rings with varying opacity (more rings for bigger effect)
                for (let i = 0; i < 4; i++) {
                    const radius = baseRadius + expansion + (i * 18);
                    const opacity = 0.9 - (i * 0.18);

                    this.ctx.beginPath();
                    this.ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
                    this.ctx.strokeStyle = `rgba(255, 255, 255, ${opacity})`;
                    this.ctx.lineWidth = 5 - i; // Thicker lines for larger size
                    this.ctx.stroke();
                }

                // Draw inner pulse (brighter to pop more against dark background)
                const pulseRadius = baseRadius - 20 + (expansion * 0.5);
                this.ctx.beginPath();
                this.ctx.arc(centerX, centerY, pulseRadius, 0, 2 * Math.PI);
                this.ctx.strokeStyle = `rgba(147, 137, 255, ${0.7 + (amplitude / 255) * 0.3})`; // Brighter purple
                this.ctx.lineWidth = 4; // Thicker inner ring
                this.ctx.stroke();
            }

            // Animation loop
            animate() {
                if (!this.isActive) return;

                // Get audio data
                this.analyser.getByteFrequencyData(this.dataArray);

                // Calculate average amplitude
                const average = this.dataArray.reduce((a, b) => a + b, 0) / this.dataArray.length;

                // Draw the ring
                this.draw(average);

                // Continue animation
                this.animationId = requestAnimationFrame(() => this.animate());
            }

            // Stop visualization
            stop() {
                this.isActive = false;
                if (this.animationId) {
                    cancelAnimationFrame(this.animationId);
                }
                if (this.audioContext) {
                    this.audioContext.close();
                }
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                document.getElementById('audio-status').textContent = '';
            }
        }

        async function startIntroExperience() {
            const playOverlayBtn = document.getElementById('play-overlay-btn');
            const pauseBtn = document.getElementById('pause-btn');
            const restartBtn = document.getElementById('restart-btn');
            const subtitleContainer = document.getElementById('subtitle-container');
            const voiceRingCanvas = document.getElementById('voice-ring');

            // Hide play overlay button, show control buttons and subtitles
            playOverlayBtn.classList.add('hidden');
            pauseBtn.classList.remove('hidden');
            restartBtn.classList.remove('hidden');
            subtitleContainer.classList.remove('hidden');
            voiceRingCanvas.classList.remove('hidden');

            // Show loading state briefly
            pauseBtn.disabled = true;
            pauseBtn.innerHTML = '<svg class="animate-spin w-5 h-5 text-white" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';

            try {
                // Load static audio file (pre-generated, no API call needed!)
                const audio = new Audio("{% static 'ai_agent/audio/nora-intro.mp3' %}");
                currentAudio = audio;

                // Initialize voice visualizer with audio
                voiceVisualizer = new VoiceVisualizer('voice-ring');
                voiceVisualizer.initWithAudio(audio);

                // Start subtitle sync
                audioStartTime = Date.now();
                syncSubtitles();

                // Handle audio end
                audio.onended = () => {
                    clearSubtitleTimeouts();
                    voiceVisualizer.stop();
                    // Show completion message
                    document.getElementById('subtitle-text').textContent = "Let's get started! 🚀";
                };

                // Play audio
                audio.play();

                // Enable pause button
                pauseBtn.disabled = false;
                pauseBtn.innerHTML = '<svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"/></svg>';
            } catch (error) {
                console.error('Error loading audio:', error);
                alert('Could not load intro audio. Please try again.');
                playOverlayBtn.classList.remove('hidden');
                pauseBtn.classList.add('hidden');
                restartBtn.classList.add('hidden');
                subtitleContainer.classList.add('hidden');
                voiceRingCanvas.classList.add('hidden');
            }
        }

        function syncSubtitles() {
            const subtitleText = document.getElementById('subtitle-text');

            subtitleSegments.forEach((segment, index) => {
                const timeout = setTimeout(() => {
                    if (!isPaused) {
                        subtitleText.textContent = segment.text;
                        currentSegmentIndex = index;
                    }
                }, segment.start);

                subtitleTimeouts.push(timeout);
            });
        }

        function pauseIntro() {
            const pauseBtn = document.getElementById('pause-btn');

            if (currentAudio) {
                if (isPaused) {
                    // Resume
                    currentAudio.play();
                    if (voiceVisualizer) {
                        voiceVisualizer.isActive = true;
                        voiceVisualizer.animate();
                        document.getElementById('audio-status').textContent = '🔊 Nora is speaking...';
                    }
                    isPaused = false;
                    pauseBtn.innerHTML = '<svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"/></svg>';
                } else {
                    // Pause
                    currentAudio.pause();
                    if (voiceVisualizer) {
                        voiceVisualizer.isActive = false;
                        document.getElementById('audio-status').textContent = '⏸️ Paused';
                    }
                    isPaused = true;
                    pauseBtn.innerHTML = '<svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"/></svg>';
                }
            }
        }

        function restartIntro() {
            const subtitleText = document.getElementById('subtitle-text');
            const pauseBtn = document.getElementById('pause-btn');

            // Reset audio
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;

                // Restart visualizer BEFORE playing to ensure it's ready
                if (voiceVisualizer) {
                    voiceVisualizer.isActive = true;
                    voiceVisualizer.animate();
                    document.getElementById('audio-status').textContent = '🔊 Nora is speaking...';
                }

                // Now play audio
                currentAudio.play().catch(error => {
                    console.error('Error playing audio:', error);
                });
            }

            // Reset subtitles
            clearSubtitleTimeouts();
            subtitleText.textContent = '';
            currentSegmentIndex = 0;
            isPaused = false;
            audioStartTime = Date.now();
            syncSubtitles();

            // Reset pause button
            pauseBtn.innerHTML = '<svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"/></svg>';
        }

        function clearSubtitleTimeouts() {
            subtitleTimeouts.forEach(timeout => clearTimeout(timeout));
            subtitleTimeouts = [];
        }

        async function startOnboarding(event) {
            event.preventDefault();

            try {
                const response = await fetch('/nora/api/start-onboarding/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                });

                if (response.ok) {
                    // Redirect to chat
                    window.location.href = '/nora/chat/';
                }
            } catch (error) {
                console.error('Error starting onboarding:', error);
                alert('Something went wrong. Please try again.');
            }
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>

</body>
</html>
