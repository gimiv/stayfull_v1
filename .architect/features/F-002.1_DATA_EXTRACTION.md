# F-002.1: Data Extraction & Enrichment (P0 Blocker)

**Status**: Spec Complete - Ready for Implementation
**Priority**: P0 - BLOCKS F-003
**Effort**: 35-40 hours (5 days)
**Parent**: F-002 AI Onboarding Agent
**Blocking**: F-003 Dynamic Commerce Engine
**Created**: 2025-10-24

---

## ðŸš¨ Why This Is P0

**Current State**: F-002 basic conversation works, but collects data through manual Q&A.

**Problem**: F-003 (Dynamic Commerce Engine) needs rich, AI-enhanced content to build hotel websites. Without data extraction, F-003 has nothing to work with.

**Dependency Chain:**
```
F-002 incomplete â†’ F-003 blocked â†’ No website generation â†’ Product fails
```

**This is a BLOCKER. Cannot proceed to F-003 until this is complete.**

---

## ðŸ“Š Gap Analysis

### What's Missing vs. F-002 Specification:

| Feature | Specified | Current State | Status |
|---------|-----------|---------------|--------|
| Google Places API | Full integration | Not integrated | âŒ P0 MISSING |
| Website Scraping | Extract all data | Code exists, broken | âŒ P0 MISSING |
| Smart Defaults | Auto-infer from location | Not implemented | âŒ P0 MISSING |
| Perplexity Research | Local attractions | Not started | âš ï¸ P1 (can defer) |
| Content Enhancement | AI descriptions | Partial | âš ï¸ P0 (needs work) |
| Image Extraction | From website | Not implemented | âš ï¸ P1 (can defer) |

**P0 = Must have before F-003**
**P1 = Nice to have, can add in v1.1**

---

## 1. Google Places API Integration (P0)

### 1.1 Purpose

**Input**: Hotel name + city
**Output**: Verified, enriched hotel data

**Why Critical**: Provides:
- âœ… Verified address (vs. user typos)
- âœ… Correct phone number
- âœ… Exact GPS coordinates
- âœ… Timezone (for bookings)
- âœ… Professional photos (if available)
- âœ… Business hours (default check-in/out)

### 1.2 When To Call

**Trigger Points:**
1. After user provides hotel name + city (no website)
2. To validate address extracted from website
3. To enrich data with photos, reviews, hours

**Flow:**
```
USER: "The Sunset Inn, Miami FL"
  â†“
NORA: "Let me look that up on Google..." [Call Google Places]
  â†“
RESULTS:
  âœ… Address: 123 Ocean Drive, Miami, FL 33139
  âœ… Phone: (305) 555-1234
  âœ… GPS: 25.7617Â° N, 80.1918Â° W
  âœ… Timezone: America/New_York
  âœ… 8 photos available
  â†“
NORA: "Found it! Is this your hotel?" [Show address for confirmation]
```

### 1.3 Implementation

**Service:** `apps/ai_agent/services/google_places_service.py`

```python
import googlemaps
from typing import Dict, Optional

class GooglePlacesService:
    """
    Google Places API integration for hotel data enrichment.

    Capabilities:
    - Search for hotels by name + location
    - Get detailed place information
    - Extract photos
    - Validate addresses
    """

    def __init__(self):
        self.client = googlemaps.Client(key=settings.GOOGLE_PLACES_API_KEY)

    def search_hotel(self, hotel_name: str, city: str, state: str = None) -> Optional[Dict]:
        """
        Search for hotel on Google Places.

        Args:
            hotel_name: "Sunset Villa"
            city: "Miami"
            state: "FL" (optional, improves accuracy)

        Returns:
            {
                "place_id": "ChIJ...",
                "name": "Sunset Villa",
                "address": "123 Ocean Drive, Miami, FL 33139",
                "phone": "+1 305-555-1234",
                "website": "https://sunsetvilla.com",
                "location": {"lat": 25.7617, "lng": -80.1918},
                "photos": ["photo_reference_1", "photo_reference_2", ...],
                "rating": 4.5,
                "user_ratings_total": 245,
                "business_status": "OPERATIONAL",
                "types": ["lodging", "hotel"],
                "opening_hours": {...}
            }
        """
        query = f"{hotel_name}, {city}"
        if state:
            query += f", {state}"

        try:
            # Text search for the hotel
            result = self.client.places(query=query, type="lodging")

            if not result.get('results'):
                return None

            # Get first result (most relevant)
            place = result['results'][0]
            place_id = place['place_id']

            # Get detailed information
            details = self.client.place(place_id=place_id, fields=[
                'name', 'formatted_address', 'international_phone_number',
                'website', 'geometry', 'photos', 'rating', 'user_ratings_total',
                'business_status', 'types', 'opening_hours'
            ])

            place_details = details.get('result', {})

            return {
                "place_id": place_id,
                "name": place_details.get('name'),
                "address": place_details.get('formatted_address'),
                "phone": place_details.get('international_phone_number'),
                "website": place_details.get('website'),
                "location": place_details.get('geometry', {}).get('location', {}),
                "photos": [p['photo_reference'] for p in place_details.get('photos', [])[:10]],
                "rating": place_details.get('rating'),
                "user_ratings_total": place_details.get('user_ratings_total'),
                "business_status": place_details.get('business_status'),
                "types": place_details.get('types', []),
                "opening_hours": place_details.get('opening_hours', {})
            }

        except Exception as e:
            logger.error(f"Google Places API error: {str(e)}")
            return None

    def infer_timezone_from_location(self, lat: float, lng: float) -> str:
        """
        Get timezone from GPS coordinates.

        Returns: "America/New_York"
        """
        try:
            result = self.client.timezone(location=(lat, lng))
            return result.get('timeZoneId', 'America/New_York')
        except Exception as e:
            logger.error(f"Timezone lookup error: {str(e)}")
            return 'America/New_York'  # Sensible default

    def download_photo(self, photo_reference: str, max_width: int = 1200) -> bytes:
        """
        Download a photo from Google Places.

        Returns: Image bytes (JPEG)
        """
        try:
            # Note: googlemaps library doesn't have direct photo method
            # Use raw API call
            url = f"https://maps.googleapis.com/maps/api/place/photo"
            params = {
                'photo_reference': photo_reference,
                'maxwidth': max_width,
                'key': settings.GOOGLE_PLACES_API_KEY
            }
            response = requests.get(url, params=params)
            return response.content
        except Exception as e:
            logger.error(f"Photo download error: {str(e)}")
            return None
```

### 1.4 Integration into NoraAgent

**File:** `apps/ai_agent/services/nora_agent.py`

```python
from .google_places_service import GooglePlacesService

class NoraAgent:
    def __init__(self, user, organization):
        # ... existing code ...
        self.google_places = GooglePlacesService()

    def _handle_hotel_basics(self, user_message: str, engine: OnboardingEngine) -> Dict:
        """
        When user provides hotel name + city (no website), use Google Places.
        """
        # Extract hotel name and city from message
        extraction = self._extract_hotel_info(user_message)

        if extraction.get('hotel_name') and extraction.get('city'):
            # Look up on Google Places
            places_data = self.google_places.search_hotel(
                hotel_name=extraction['hotel_name'],
                city=extraction['city'],
                state=extraction.get('state')
            )

            if places_data:
                # Store in context for confirmation
                self.context.task_state['_places_data_pending'] = places_data
                self.context.task_state['_awaiting_places_confirmation'] = True
                self.context.save()

                return {
                    "message": f"I found {places_data['name']} on Google:\n\n"
                               f"ðŸ“ {places_data['address']}\n"
                               f"ðŸ“ž {places_data.get('phone', 'No phone listed')}\n\n"
                               f"Is this your hotel?",
                    "data": {"places_data": places_data},
                    "action": "confirm_places_data"
                }
```

### 1.5 Acceptance Criteria

- [ ] Google Places API key configured in `.env`
- [ ] Search by hotel name + city returns correct result
- [ ] Detailed place info retrieved (address, phone, photos)
- [ ] Timezone inferred from GPS coordinates
- [ ] Photos downloadable (first 10)
- [ ] Graceful fallback if API fails (continue with manual Q&A)
- [ ] User confirms Google data before using it
- [ ] Test with 3 real hotels (different cities)

---

## 2. Website Scraping (Fix Existing Code) (P0)

### 2.1 Current State

**Code exists** in `apps/ai_agent/services/data_extractor.py` but is **not working**.

**Issues Found:**
1. Not being called in conversation flow
2. GPT-4o extraction prompt may be too vague
3. No error handling for failed scrapes
4. Not extracting images

### 2.2 What Must Be Fixed

**Fix 1: Integration into conversation flow**

File: `apps/ai_agent/services/nora_agent.py`

```python
def _handle_website_url(self, user_message: str, engine: OnboardingEngine) -> Dict:
    """
    Currently partially implemented - needs completion.
    """
    # Extract URL
    url = self.intent_detector.extract_url(user_message)

    if not url:
        return {"message": "I don't see a URL there. Can you paste your website address?"}

    # Scrape website
    extracted_data = self.data_extractor.extract_from_website(url)

    if extracted_data.get('error'):
        # Fallback: Continue with manual Q&A
        return {
            "message": f"I couldn't access {url}. No problem - let's do this the old-fashioned way. "
                       f"What's your hotel's name?",
            "action": "continue_manual"
        }

    # Success! Store extracted data and ask for confirmation
    self.context.task_state.update({
        'hotel_name': extracted_data.get('hotel_name'),
        'full_address': extracted_data.get('address'),
        'city': extracted_data.get('city'),
        'state': extracted_data.get('state'),
        'country': extracted_data.get('country'),
        'phone': extracted_data.get('phone'),
        'contact_email': extracted_data.get('email'),
        'description': extracted_data.get('description'),
        'amenities': extracted_data.get('amenities', []),
        'room_types': extracted_data.get('room_types', []),
        'website': url,
        '_extracted_from_website': True
    })

    # Now enrich with Google Places
    if extracted_data.get('hotel_name') and extracted_data.get('city'):
        places_data = self.google_places.search_hotel(
            hotel_name=extracted_data['hotel_name'],
            city=extracted_data['city'],
            state=extracted_data.get('state')
        )

        if places_data:
            # Merge Google Places data (GPS, timezone, photos)
            self.context.task_state.update({
                'latitude': places_data['location'].get('lat'),
                'longitude': places_data['location'].get('lng'),
                'timezone': self.google_places.infer_timezone_from_location(
                    places_data['location']['lat'],
                    places_data['location']['lng']
                ),
                'google_place_id': places_data['place_id']
            })

    # Infer smart defaults
    self._apply_smart_defaults()

    self.context.save()

    return {
        "message": f"Perfect! I pulled everything from {url}:\n\n"
                   f"âœ… {extracted_data['hotel_name']}\n"
                   f"âœ… {extracted_data.get('address', 'Address found')}\n"
                   f"âœ… {len(extracted_data.get('amenities', []))} amenities\n"
                   f"âœ… {len(extracted_data.get('room_types', []))} room types\n\n"
                   f"Does this look right?",
        "data": {"extracted": extracted_data},
        "action": "show_preview"
    }
```

**Fix 2: Improve GPT-4o extraction prompt**

File: `apps/ai_agent/services/data_extractor.py`

Current prompt is too vague. Need more specific instructions:

```python
extraction_prompt = f"""
You are extracting hotel information from this website HTML.

Extract ONLY information that is explicitly stated. Do not guess or infer.

REQUIRED FIELDS:
1. hotel_name - The name of the hotel (look in <title>, <h1>, or header)
2. address - Full street address (number, street, city, state/province, zip, country)
3. city - City name only
4. state - State or province (2-letter code if US/Canada)
5. country - Full country name
6. phone - Phone number in any format
7. email - Contact email address

OPTIONAL FIELDS:
8. description - Brief hotel description (1-2 sentences, from About or homepage)
9. amenities - List of hotel amenities (pool, wifi, parking, etc.)
10. room_types - Names of room categories mentioned (e.g., "Deluxe Suite", "Ocean View")

IMPORTANT RULES:
- If a field is not found, set it to null
- For address: Look for "Address", "Location", "Visit Us", footer
- For phone: Look for "Contact", "Call", "Reservations"
- For email: Look for "Contact", "Email", "Reservations"
- For room_types: Look for "Rooms", "Accommodations", "Suites"
- Extract EXACTLY as written on the website (don't reformat)
- Set confidence to 0.9 if all required fields found, 0.5 if 50% found, 0.0 if <50% found

HTML Content:
{text_content}

Respond with ONLY valid JSON (no markdown, no extra text):
{{
    "hotel_name": "...",
    "address": "...",
    "city": "...",
    "state": "...",
    "country": "...",
    "phone": "...",
    "email": "...",
    "description": "...",
    "amenities": ["...", "..."],
    "room_types": ["...", "..."],
    "confidence": 0.0-1.0
}}
"""
```

### 2.3 Acceptance Criteria

- [ ] Website URL triggers scraping automatically
- [ ] Extraction success rate >80% on test websites
- [ ] Extracted data stored in task_state correctly
- [ ] User confirms extracted data before proceeding
- [ ] Graceful fallback to manual Q&A if scraping fails
- [ ] Test with 5 real hotel websites (various CMSs)
- [ ] Error logging for failed scrapes

---

## 3. Smart Defaults (P0)

### 3.1 Purpose

**Reduce user friction** by auto-inferring data from location.

### 3.2 What to Infer

| From | Infer | Logic |
|------|-------|-------|
| Country | Currency | US â†’ USD, UK â†’ GBP, EU â†’ EUR |
| State/Province | Tax Rate | FL â†’ 13%, CA â†’ 10.5%, etc. |
| GPS Coordinates | Timezone | Google Places API |
| City | Language | Miami â†’ English, Montreal â†’ French + English |

### 3.3 Implementation

**File:** `apps/ai_agent/services/data_extractor.py`

```python
def infer_smart_defaults(self, country: str, state: str = None, city: str = None) -> Dict:
    """
    Infer currency, timezone, tax rate from location.

    Returns:
        {
            "currency": "USD",
            "tax_rate": 13.0,  # percentage
            "language": "en"
        }
    """
    # Currency mapping
    currency_map = {
        'United States': 'USD',
        'US': 'USD',
        'USA': 'USD',
        'Canada': 'CAD',
        'United Kingdom': 'GBP',
        'UK': 'GBP',
        'France': 'EUR',
        'Germany': 'EUR',
        'Spain': 'EUR',
        'Italy': 'EUR',
        'Mexico': 'MXN',
        'Australia': 'AUD',
    }

    # US state tax rates (hotel + local average)
    us_tax_rates = {
        'FL': 13.0,  # Florida (state + local)
        'CA': 10.5,  # California
        'NY': 14.75,  # New York
        'TX': 17.0,  # Texas (high local taxes)
        'NV': 13.38,  # Nevada
        # ... add more states
    }

    currency = currency_map.get(country, 'USD')
    tax_rate = 10.0  # Default

    if country in ['US', 'USA', 'United States'] and state:
        tax_rate = us_tax_rates.get(state.upper(), 10.0)

    return {
        "currency": currency,
        "tax_rate": tax_rate,
        "language": "en"  # Default English for MVP
    }
```

### 3.4 Integration

After extracting location data (from website or Google Places), automatically call:

```python
defaults = self.data_extractor.infer_smart_defaults(
    country=self.context.task_state.get('country'),
    state=self.context.task_state.get('state'),
    city=self.context.task_state.get('city')
)

self.context.task_state.update(defaults)
```

### 3.5 Acceptance Criteria

- [ ] Currency correctly inferred for 10+ countries
- [ ] Tax rate correctly inferred for 10+ US states
- [ ] Timezone from Google Places GPS coordinates
- [ ] Defaults applied automatically (user doesn't see these questions)
- [ ] User can edit defaults in Review step if wrong

---

## 4. Content Enhancement (P0)

### 4.1 Current State

**Partial implementation** in `apps/ai_agent/services/content_formatter.py`

**What's Missing:**
- Room descriptions not being enhanced automatically
- Hotel description not generated if user doesn't provide one
- Policy formatting inconsistent

### 4.2 What Must Work

**Enhancement 1: Room Descriptions**

Input: "Nice room with bed"
Output: "Experience comfort in our elegantly appointed room featuring plush bedding, modern amenities, and serene views. Perfect for both business and leisure travelers seeking a peaceful retreat."

**Enhancement 2: Hotel Description**

Input: Hotel name "Sunset Villa" + city "Miami"
Output: "Escape to Sunset Villa, your coastal paradise in the heart of Miami. Experience luxury accommodations, world-class amenities, and breathtaking ocean views just steps from South Beach's vibrant dining and entertainment."

### 4.3 Fix Required

**File:** `apps/ai_agent/services/content_formatter.py`

```python
def enhance_room_description(self, basic_description: str, room_name: str, hotel_context: Dict) -> str:
    """
    Transform basic user input into guest-ready description.

    Args:
        basic_description: "Nice room with king bed"
        room_name: "Ocean View King"
        hotel_context: {"hotel_name": "Sunset Villa", "city": "Miami", "amenities": [...]}

    Returns:
        "Experience oceanfront luxury in our Ocean View King room..."
    """
    prompt = f"""
You are writing hotel room descriptions for a booking website.

Hotel: {hotel_context.get('hotel_name')} in {hotel_context.get('city')}
Room Type: {room_name}
Basic Info: {basic_description}
Hotel Amenities: {', '.join(hotel_context.get('amenities', []))}

Write a 2-3 sentence guest-facing room description that:
1. Starts with an emotional hook ("Experience...", "Unwind in...", "Discover...")
2. Highlights the room's key features
3. Mentions the location/hotel context naturally
4. Uses vivid, inviting language
5. Avoids clichÃ©s like "perfect getaway"
6. Focuses on the GUEST experience, not just features

Style: Airbnb-level quality, warm but professional.

Write ONLY the description (no quotes, no extra text):
"""

    response = self.client.chat.completions.create(
        model="gpt-4o",
        messages=[{"role": "user", "content": prompt}],
        temperature=0.7,
        max_tokens=150
    )

    return response.choices[0].message.content.strip()
```

### 4.4 Acceptance Criteria

- [ ] Every room type gets AI-enhanced description automatically
- [ ] Hotel description generated if user provides none
- [ ] Descriptions are 2-3 sentences (not too long)
- [ ] Quality comparable to Airbnb listings
- [ ] User can click "Regenerate" to get new version
- [ ] Test with 10 different room types

---

## 5. Implementation Plan

### Phase 1: Google Places Integration (12 hours)

**Day 1 (6 hours):**
- [ ] Install `googlemaps` package
- [ ] Create `google_places_service.py`
- [ ] Implement `search_hotel()` method
- [ ] Implement `infer_timezone_from_location()`
- [ ] Write unit tests (5 test hotels)

**Day 2 (6 hours):**
- [ ] Integrate into `nora_agent.py` conversation flow
- [ ] Add confirmation step for Google data
- [ ] Handle API errors gracefully
- [ ] Test with 10 real hotels
- [ ] Verify timezone accuracy

### Phase 2: Website Scraping Fix (8 hours)

**Day 3 (8 hours):**
- [ ] Fix `_handle_website_url()` in `nora_agent.py`
- [ ] Improve GPT-4o extraction prompt
- [ ] Add error handling for failed scrapes
- [ ] Test with 10 different hotel websites
- [ ] Verify extraction accuracy (target >80%)
- [ ] Add logging for debugging

### Phase 3: Smart Defaults (4 hours)

**Day 4 Morning (4 hours):**
- [ ] Implement `infer_smart_defaults()` in `data_extractor.py`
- [ ] Add currency mappings (20+ countries)
- [ ] Add US state tax rates (50 states)
- [ ] Integrate into conversation flow
- [ ] Test with hotels in 10 different states/countries

### Phase 4: Content Enhancement (6 hours)

**Day 4 Afternoon + Day 5 (6 hours):**
- [ ] Fix `enhance_room_description()` in `content_formatter.py`
- [ ] Implement `generate_hotel_description()`
- [ ] Add "Regenerate" functionality
- [ ] Test with 20 different room types
- [ ] Verify quality (manual review)
- [ ] Integrate auto-enhancement into data generation

### Phase 5: Testing & Polish (5 hours)

**Day 5 (5 hours):**
- [ ] End-to-end test with 5 real hotels
- [ ] Run quality audit (from `.architect/tasks/`)
- [ ] Fix any bugs found
- [ ] Update documentation
- [ ] Commit all changes

**Total: 35 hours (~5 days)**

---

## 6. Acceptance Criteria (Quality Gate)

### Before F-003 Can Begin:

- [ ] **Google Places working**: 90%+ success rate finding hotels
- [ ] **Website scraping working**: 80%+ extraction accuracy
- [ ] **Smart defaults working**: Currency + tax rate auto-set for 90% of hotels
- [ ] **Content enhancement working**: All descriptions AI-enhanced automatically
- [ ] **End-to-end test passes**: Complete onboarding in <15 minutes with extracted data
- [ ] **Quality audit score**: 80/100+ on conversation quality test
- [ ] **No P0 bugs**: Zero critical bugs in onboarding flow

**If ANY of these fail â†’ F-002.1 is incomplete â†’ F-003 is BLOCKED**

---

## 7. Risk Assessment

### Risk 1: Google Places API Cost
**Impact**: HIGH - Cost overrun
**Probability**: LOW
**Mitigation**:
- Cache results (don't call API twice for same hotel)
- $0.017 per lookup = very cheap
- Budget: $50/month = 2,900 lookups

### Risk 2: Website Scraping Fails
**Impact**: MEDIUM - Manual Q&A fallback
**Probability**: MEDIUM (30% of websites)
**Mitigation**:
- Always have Google Places as backup
- Graceful fallback to manual questions
- User experience still acceptable

### Risk 3: GPT-4o Extraction Inaccurate
**Impact**: MEDIUM - Wrong data entered
**Probability**: LOW
**Mitigation**:
- Always require user confirmation
- Show extracted data for review
- User can edit before proceeding

---

## 8. Success Metrics

**After F-002.1 Implementation:**

- âœ… Onboarding time: **<15 minutes** (down from 25)
- âœ… Data extraction success: **80%+** of hotels
- âœ… Google Places hit rate: **90%+**
- âœ… Manual questions reduced: **from 20 to <10**
- âœ… User satisfaction: **NPS 50+**
- âœ… Completion rate: **90%+** (vs 40% industry)

---

## 9. Developer Handoff

**Next Steps:**

1. Architect creates detailed task list
2. Developer estimates each task
3. Developer begins Phase 1 (Google Places)
4. Daily check-ins with architect
5. Quality review after each phase
6. Final approval before F-003 begins

**This is BLOCKING work. All other features on hold until complete.**

---

**Questions? Blockers? Ask the architect immediately.**
